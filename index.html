<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
</head>
<body>
  <h1>Object Detection with TensorFlow.js</h1>
  <button id="start-button">Start Camera</button>
  <video id="video" width="640" height="480" autoplay muted></video>
  <div id="predictions"></div>
  <script>
    // Get the video element and the start button
    const video = document.getElementById("video");
    const startButton = document.getElementById("start-button");

    // Define variables for audio context
    let audioContext;
    
    // Flags to track detection state of each object type
    let personDetected = false;
    let cellphoneDetected = false;
    let chairDetected = false;

    // Load the COCO-SSD model
    let model;
    cocoSsd.load().then(loadedModel => {
      model = loadedModel;
      console.log("Model loaded");
    });

    // Define a function to start the camera and audio context
    function startCamera() {
      // Initialize the audio context
      audioContext = new AudioContext();

      // Ask for permission to access the camera
      navigator.mediaDevices.getUserMedia({video: true})
        .then(stream => {
          // Set the video source to the stream
          video.srcObject = stream;
          // Start the video
          video.play();
          // Run the object detection every 100 milliseconds
          setInterval(runDetection, 100);
        })
        .catch(error => {
          // Handle the error
          console.error(error);
          alert("Please allow access to the camera");
        });
    }

    // Define a function to play a randomly chosen modal chord
    function playRandomModalChord() {
      const modes = [
        { name: 'Ionian', intervals: [0, 4, 7] }, // Major chord
        { name: 'Dorian', intervals: [0, 3, 7] },
        { name: 'Phrygian', intervals: [0, 3, 7] },
        { name: 'Lydian', intervals: [0, 4, 7] },
        { name: 'Mixolydian', intervals: [0, 4, 7] },
        { name: 'Aeolian', intervals: [0, 3, 7] }, // Minor chord
        { name: 'Locrian', intervals: [0, 3, 6] }
      ];
      const rootFrequency = 440; // A4
      const mode = modes[Math.floor(Math.random() * modes.length)];
      const chordFrequencies = mode.intervals.map(interval => 
        rootFrequency * Math.pow(2, interval / 12)
      );

      // Reduce the gain for each oscillator to avoid distortion
      const gainValue = 1 / chordFrequencies.length;

      chordFrequencies.forEach(frequency => {
        const oscillator = audioContext.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

        const envelope = audioContext.createGain();
        envelope.gain.setValueAtTime(0, audioContext.currentTime);
        envelope.gain.linearRampToValueAtTime(gainValue, audioContext.currentTime + 0.01); // Attack
        envelope.gain.linearRampToValueAtTime(0, audioContext.currentTime + 1); // Release

        oscillator.connect(envelope);
        envelope.connect(audioContext.destination);

        oscillator.start();
        oscillator.stop(audioContext.currentTime + 1);
      });

      soundPlayed = true; // Set the flag to true after playing the sound
    }

    // Define a function to run the object detection
    function runDetection() {
      // Check if the model is loaded
      if (model) {
        // Detect objects in the video frame
        model.detect(video)
          .then(predictions => {
            // Reset detection flags if no objects are detected
            if (predictions.length === 0) {
              personDetected = cellphoneDetected = chairDetected = false;
            }

            predictions.forEach(prediction => {
              // Check for new detections and play sound accordingly
              if (prediction.class === 'person' && !personDetected) {
                playRandomModalChord();
                personDetected = true;
              } else if (prediction.class === 'cell phone' && !cellphoneDetected) {
                playRandomModalChord();
                cellphoneDetected = true;
              } else if (prediction.class === 'chair' && !chairDetected) {
                playRandomModalChord();
                chairDetected = true;
              }
            });

            // Display the predictions on the webpage
            displayPredictions(predictions);
          });
      }
    }

    // Define a function to display predictions
    function displayPredictions(predictions) {
      // Clear any previous predictions displayed
      const predictionsContainer = document.getElementById("predictions");
      predictionsContainer.innerHTML = '';

      // Create elements for each prediction and add to the container
      predictions.forEach(prediction => {
        const p = document.createElement("p");
        p.innerText = `Detected: ${prediction.class} with ${Math.round(prediction.score * 100)}% confidence`;
        predictionsContainer.appendChild(p);
      });
    }

    // Add a click event listener to the start button
    startButton.addEventListener("click", startCamera);
  </script>
</body>
</html>
