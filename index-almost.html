<!DOCTYPE html>
<html>
<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <title>Web Audio Example</title>
  <!-- Load the js-objectdetect library -->
  <script src="js/objectdetect.js"></script>
  <!-- Declare and initialize a global variable for the classifier -->
  <!-- <script>
    var classifier = new objectdetect.detector(640, 480, 1.1, objectdetect.frontalface);
  </script> -->
</head>
<body>
  <h1>Web Audio Example</h1>
  <p>This is a simple website that uses the web audio API to trigger a sound by motion detected by the webcam.</p>
  <!-- Create a button element for the play button -->
  <button id="play-button">Play Sound</button>
  <!-- Create a video element for the webcam stream -->
  <video id="video" autoplay></video>
  <!-- Create a canvas element for the motion detection -->
  <canvas id="canvas"></canvas>
  <script>
    // Define the modal chords as arrays of frequencies
    var dorianChord = [261.63, 329.63, 392, 523.25]; // C Dorian: C min6, F 9
    var phrygianChord = [261.63, 277.18, 349.23, 415.3]; // C Phrygian: C min, D♭ maj
    var lydianChord = [261.63, 329.63, 415.3, 493.88]; // C Lydian: C maj7♭5, B -7
    var mixolydianChord = [261.63, 329.63, 392, 466.16]; // C Mixolydian: C 13, E -7♭5

    // Create an array of modal chords
    var modalChords = [dorianChord, phrygianChord, lydianChord, mixolydianChord];

    // Get the video and canvas elements
    var video = document.getElementById("video");
    var canvas = document.getElementById("canvas");

    // Set the canvas size to match the video size
    canvas.width = 640;
    canvas.height = 480;

    // Get the canvas context
    var context = canvas.getContext("2d");

    // Declare a variable for the audio context
    var audioContext;

    // Get the button element
    var button = document.getElementById("play-button");

    // Add a click event listener to the button
    button.addEventListener("click", function() {
      // Create a new audio context
      audioContext = new AudioContext();

      // Create a gain node for the volume
      var gainNode = audioContext.createGain();
      gainNode.gain.value = 0.5; // Set the volume to 50%

      // Connect the gain node to the destination (speakers)
      gainNode.connect(audioContext.destination);

      // Create a convolver node for the reverb effect
      var convolver = audioContext.createConvolver();

      // Fetch the impulse response from the local directory
      fetch("6 Spaces 06 Scoring Stage  M-to-S.wav")
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
        .then(audioBuffer => {
          // Set the impulse response to the convolver
          convolver.buffer = audioBuffer;

          // Connect the convolver to the gain node
          convolver.connect(gainNode);
        })
        .catch(e => console.error(e));

        // Query the permission status for the camera and request the permission if needed
    navigator.permissions.query({name: "camera"})
        .then(function(permissionStatus) {
          // If the permission is granted
          if (permissionStatus.state === "granted") {
            // Call the function to access the webcam
            accessWebcam();
          }
          // If the permission is denied
          else if (permissionStatus.state === "denied") {
            // Log the error
            console.error("Access to the camera is denied");
            accessWebcam();
          }
          // If the permission is prompt
          else if (permissionStatus.state === "prompt") {
            // Request the permission
            navigator.mediaDevices.getUserMedia({video: true})
              .then(function(stream) {
                // Call the function to access the webcam
                accessWebcam();
              })
              .catch(function(error) {
                // Log the error
                console.error(error);
              });
          }
        })
        .catch(function(error) {
          // Log the error
          console.error(error);
        });
      
    });

    // Define a motion threshold
    var motionThreshold = 1000;

    // Define a flag to indicate if the sound is playing
    var isPlaying = false;

    // Define a function to play a random modal chord
    function playChord() {
      // Generate a random number between 0 and 3
      var randomIndex = Math.floor(Math.random() * 4);

      // Select a random modal chord from the array
      var modalChord = modalChords[randomIndex];

      // Loop through the frequencies of the modal chord
      for (var i = 0; i < modalChord.length; i++) {
        // Create a sine wave oscillator for each frequency
        var oscillator = audioContext.createOscillator();
        oscillator.type = "sine";
        oscillator.frequency.value = modalChord[i];

        // Create a gain node for the envelope
        var envelope = audioContext.createGain();
        envelope.gain.value = 0; // Initial volume

        // Connect the oscillator to the envelope
        oscillator.connect(envelope);

        // Connect the envelope to the convolver
        envelope.connect(convolver);

        // Start the oscillator
        oscillator.start();

        // Create a new time constant for the envelope
        var now = audioContext.currentTime;

        // Set the envelope parameters
        var attack = 0.1; // Time to reach maximum volume
        var decay = 0.2; // Time to reach sustain volume
        var sustain = 0.5; // Sustain volume level
        var release = 0.5; // Time to reach zero volume

        // Apply the envelope to the gain node
        envelope.gain.cancelScheduledValues(now); // Cancel any previous changes
        envelope.gain.setValueAtTime(0, now); // Set the initial volume to zero
        envelope.gain.linearRampToValueAtTime(1, now + attack); // Ramp up to maximum volume
        envelope.gain.linearRampToValueAtTime(sustain, now + attack + decay); // Ramp down to sustain volume
        envelope.gain.linearRampToValueAtTime(0, now + attack + decay + release); // Ramp down to zero volume

        // Stop the oscillator after the release time
        oscillator.stop(now + attack + decay + release);
      }

      // Set the flag to true
      isPlaying = true;

      // Set a timeout to reset the flag after the release time
      setTimeout(function() {
        isPlaying = false;
      }, (attack + decay + release) * 1000);
    }

    // Define a function to detect motion and draw a rectangle
    function detectMotion() {
      //define classifier
      //var classifier = new objectdetect.detector(640, 480, 1.1, objectdetect.frontalface);
      // Draw the video frame on the canvas
      context.drawImage(video, 0, 0, 640, 480);

      // Get the image data from the canvas
      var imageData = context.getImageData(0, 0, 640, 480);

      // Detect the coordinates of the moving objects using the global variable classifier
      var coords = classifier.detect(imageData, 1);

      // Clear the previous rectangle
      context.clearRect(0, 0, 640, 480);

      // Loop through the coordinates
      for (var i = 0; i < coords.length; i++) {
        // Get the x, y, width, and height of the current coordinate
        var x = coords[i][0];
        var y = coords[i][1];
        var width = coords[i][2];
        var height = coords[i][3];

        // Calculate the area of the rectangle
        var area = width * height;

        // Draw a red rectangle around the moving object
        context.strokeStyle = "red";
        context.strokeRect(x, y, width, height);

        // If the area is above the motion threshold and the sound is not playing
        if (area > motionThreshold && !isPlaying) {
          // Play a random modal chord
          playChord();
        }
      }

      // Request the next animation frame
      requestAnimationFrame(detectMotion);
    }

    // Define a function to access the webcam
    function accessWebcam() {
      // Define the constraints for the video stream
      var constraints = {
        audio: false,
        video: {
          width: 640,
          height: 480
        }
      };

      // Request access to the webcam
      navigator.mediaDevices.getUserMedia(constraints)
        .then(function(stream) {
          // Set the video source to the stream
          video.srcObject = stream;

          // Wait for the video to be ready
          video.onloadedmetadata = function() {
            // Play the video
            video.play();

            // Start the motion detection
            detectMotion();
          };
        })
        .catch(function(error) {
          // Log the error
          console.error(error);
        });
    }
</script>
</body>
</html>